var playState={init:function(b){this.levelID=b.levelID;this.lignes=0;this.colonnes=0;this.chrono={min:0,sec:0};this.initialTime=0;switch(this.levelID){case 1:this.lignes=4;this.colonnes=3;this.bordureX=game.get1Position(20);break;case 2:this.lignes=4;this.colonnes=4;this.bordureX=game.get1Position(5);break;case 3:this.lignes=5;this.colonnes=4;this.bordureX=game.get1Position(5);break}this.filenames=["prs01","prs02","prs03","prs04","prs05","prs06","prs07","prs08","prs09","prs10"];this.filenames=game.shuffleArray(this.filenames);this.tableau=new Array();this.nbimages=(this.lignes*this.colonnes)/2;for(var a=0;a<this.nbimages;a++){this.tableau.push(this.filenames[a])}this.tabimgs=new Array();this.curSelect=new Array();this.totSelect=new Array()},preload:function(){if(this.levelID==1){this.scb=game.ismobile==true?1.05:0.99}else{this.scb=game.ismobile==true?1:0.99}var b=game.add.sprite(0,0,"bkg");b.y=0;game.set2Scale(b);game.addMusicButton();game.addPauseButton();game.addDisplayLoader();game.load.onFileComplete.add(this.filecomplete,this);game.load.onLoadComplete.add(this.loadcomplete,this);for(var a=0;a<this.tableau.length;a++){game.load.image(this.tableau[a],game.pathImg+"png/"+this.tableau[a]+".png")}game.load.image("cadre1",game.pathImg+"png/lv"+this.levelID+"_cadre1.png");game.load.image("cadre2",game.pathImg+"png/lv"+this.levelID+"_cadre1.png");game.load.image("verso1",game.pathImg+"png/verso1.png");game.load.image("verso2",game.pathImg+"png/verso2.png");for(var a=0;a<10;a++){game.load.image("ch"+a,game.pathImg+"png/"+a+".png")}game.load.image("period",game.pathImg+"png/period.png");game.load.image("levels",game.pathText+"level"+this.levelID+".png");game.load.image("btimer",game.pathText+"timer.png");game.load.spritesheet("txt1",game.pathText+"txt1.png",194*game.mratio,104*game.mratio);game.load.image("tracking02",game.pathTrack+"pixel.gif?r=play"+this.levelID)},create:function(){switch(this.levelID){case 1:this.music=game.add.audio("musiclevel1");break;case 2:this.music=game.add.audio("musiclevel2");break;case 3:this.music=game.add.audio("musiclevel3");break}this.cardflip=game.add.audio("cardflip");this.cardmatch=game.add.audio("cardmatch");this.cardnomatch=game.add.audio("cardnomatch");this.allcards=game.add.audio("allcards");this.flipSpeed=300;this.flipZoom=1.2;this.initScale=game.get2Scale();this.delayFlip=2000;this.isFlipping=false;this.levels=game.add.image(0,0,"levels");this.btimer=game.add.image(0,0,"btimer");this.levels.anchor.set(1,0);this.btimer.anchor.set(1,0);game.set2Scale(this.levels);game.set2Scale(this.btimer);game.set2Position(800,80,this.levels);game.set2Position(800,130,this.btimer);var j=game.add.image(0,0,"ch0");j.anchor.set(1,0);game.set2Scale(j);var g=game.add.image(0,0,"ch0");g.anchor.set(1,0);game.set2Scale(g);var f=game.add.image(0,0,"ch0");f.anchor.set(1,0);game.set2Scale(f);var e=game.add.image(0,0,"ch0");e.anchor.set(1,0);game.set2Scale(e);this.curbmpTime=new Array(j,g,f,e);this.period=game.add.image(0,0,"period");this.period.anchor.set(1,0);game.set2Scale(this.period);game.set2Position(794,160,e);game.set2Position(768,160,f);game.set2Position(742,155,this.period);game.set2Position(730,160,g);game.set2Position(704,160,j);var B=game.add.sprite(0,0,"goku");B.smoothed=true;game.set2ScaleP(B,0.5);B.anchor.set(0,0);game.set2Position(600,280,B);this.texte=game.add.sprite(0,0,"txt1");game.set2ButtonScaleP(this.texte,this.scb);if(this.levelID==1){game.set2Position(698,270,this.texte)}else{game.set2Position(708,270,this.texte)}this.texte.anchor.set(0.5,0.5);this.texte.scale.setTo(0.1,0.1);this.texte.visible=false;for(var G=0;G<this.tableau.length;G++){for(var x=0;x<2;x++){var E=new Object();E.pos=0;E.name=this.tableau[G];E.verso="";E.recto="";this.tabimgs.push(E)}}this.tabimgs=game.shuffleArray(this.tabimgs);var z=this.levelID==1?game.get1Position(4):game.get1Position(1);var v=game.get1Position(this.bordureX);var t=game.get1Position(20);var D=0;for(var G=0;G<this.tabimgs.length;G++){this.tabimgs[G]["pos"]=G;var A=(G%2)+1;var K=(G%this.colonnes);if(K==0&&G>=this.colonnes){D++}if(this.colonnes%2==0){A=D%2==1?A-1:A;A=D%2==1&&A==0?A=2:A}var y=game.add.image(0,0,"cadre"+A);y.anchor.set(0.5,0.5);var u=y.width;var q=y.height;game.set2Scale(y);var r=y.width/2;var p=y.height/2;var s=y.width+z;var I=y.height+z;var m=v+s*K;var k=t+I*D;y.x=m+this.bordureX+r;y.y=k+p;var F=game.make.bitmapData(u-2,q-2);F.fill(0,209,23);var H=game.make.bitmapData(u,q);var o=game.add.image(0,0,this.tabimgs[G]["name"]);var d=parseFloat(u/o.width).toFixed(2);o.scale.setTo(d,d);H.alphaMask(o,F);o.destroy();var J=game.add.image(0,0,H);J.anchor.set(0.5,0.5);J.x=m+this.bordureX+1+r;J.y=k+1+p;this.tabimgs[G]["recto"]=J;game.set2Scale(J);J.scale.setTo(0,this.flipZoom);var b=game.make.bitmapData(u,q);var C=game.add.image(0,0,"verso"+A);C.scale.setTo(d,d);b.alphaMask(C,F);C.destroy();var a=game.add.image(0,0,b);a.anchor.set(0.5,0.5);a.x=m+this.bordureX+1+r;a.y=k+1+p;this.tabimgs[G]["verso"]=a;game.set2Scale(a);var x=G<10?"0"+G:G;y.name="perso"+G;y.data={pos:G,isflipping:false};y.inputEnabled=true;y.events.onInputUp.add(this.buttonUp,this);y.bringToTop()}this.ctimer=game.time.create(false);this.ctimer.loop(1000,this.displayTimer,this);this.ctimer.start();this.music.play("",0,0.2,true,true)},filecomplete:function(a,d,e,b,c){game.processLoader(a)},loadcomplete:function(){game.destroyLoader()},buttonUp:function(c){var g=c.data.pos;if(this.curSelect.length<2&&c.data.isflipping==false&&this.isFlipping==false){this.cardflip.play("",0,0.3,false,true);c.data.isflipping=true;this.curSelect.push({pos:g,e:c});this.flipTween=game.add.tween(this.tabimgs[g]["verso"].scale).to({x:0,y:this.flipZoom},this.flipSpeed/2,Phaser.Easing.Linear.None);this.flipCadre=game.add.tween(c.scale).to({x:0,y:this.flipZoom},this.flipSpeed/2,Phaser.Easing.Linear.None);this.backFlipTween=game.add.tween(this.tabimgs[g]["recto"].scale).to({x:this.initScale,y:this.initScale},this.flipSpeed/2,Phaser.Easing.Linear.None);this.backFlipCadre=game.add.tween(c.scale).to({x:this.initScale,y:this.initScale},this.flipSpeed/2,Phaser.Easing.Linear.None);this.flipTween.onComplete.add(function(){this.backFlipTween.start();this.backFlipCadre.start()},this);this.backFlipTween.onComplete.add(function(){},this);this.flipTween.start();this.flipCadre.start()}if(this.curSelect.length==2){game.input.enabled=false;this.isFlipping=true;var f=this.curSelect[0]["pos"];var b=this.curSelect[1]["pos"];var d=this.curSelect[0]["e"];var a=this.curSelect[1]["e"];d.inputEnabled=false;a.inputEnabled=false;this.ctimer.pause();if(this.tabimgs[f]["name"]==this.tabimgs[b]["name"]&&f!=b){this.curSelect=new Array();this.totSelect.push(this.tabimgs[f]);if(this.totSelect.length==this.tabimgs.length/2){this.ctimer.stop();this.tweenAndText(2)}else{this.tweenAndText(1)}}else{tt=this;this.tweenAndText(0);setTimeout(function(){if(tt.curSelect.length==2){tt.ctimer.resume();var l=0;var n=tt.curSelect[l]["pos"];var m=tt.curSelect[l]["e"];this.flipTween2=game.add.tween(tt.tabimgs[n]["recto"].scale).to({x:0,y:tt.flipZoom},tt.flipSpeed/2,Phaser.Easing.Linear.None);this.flipTween2.onComplete.add(function(){this.backFlipTween2.start();this.backFlipCadre2.start();m.data.isflipping=false;m.inputEnabled=true},this);this.flipCadre2=game.add.tween(m.scale).to({x:0,y:tt.flipZoom},tt.flipSpeed/2,Phaser.Easing.Linear.None);this.backFlipCadre2=game.add.tween(m.scale).to({x:tt.initScale,y:tt.initScale},tt.flipSpeed/2,Phaser.Easing.Linear.None);this.backFlipTween2=game.add.tween(tt.tabimgs[n]["verso"].scale).to({x:tt.initScale,y:tt.initScale},tt.flipSpeed/2,Phaser.Easing.Linear.None);this.flipTween2.start();this.flipCadre2.start();var h=1;var k=tt.curSelect[h]["pos"];var j=tt.curSelect[h]["e"];this.flipTween22=game.add.tween(tt.tabimgs[k]["recto"].scale).to({x:0,y:tt.flipZoom},tt.flipSpeed/2,Phaser.Easing.Linear.None);this.flipTween22.onComplete.add(function(){this.backFlipTween22.start();this.backFlipCadre22.start();j.data.isflipping=false;j.inputEnabled=true},this);this.flipCadre22=game.add.tween(j.scale).to({x:0,y:tt.flipZoom},tt.flipSpeed/2,Phaser.Easing.Linear.None);this.backFlipCadre22=game.add.tween(j.scale).to({x:tt.initScale,y:tt.initScale},tt.flipSpeed/2,Phaser.Easing.Linear.None);this.backFlipCadre22.onComplete.add(function(){tt.isFlipping=false;game.input.enabled=true;tt.curSelect=new Array()});this.backFlipTween22=game.add.tween(tt.tabimgs[k]["verso"].scale).to({x:tt.initScale,y:tt.initScale},tt.flipSpeed/2,Phaser.Easing.Linear.None);this.flipTween22.start();this.flipCadre22.start()}},tt.delayFlip)}}},displayTimer:function(){this.initialTime++;var e=this.initialTime;e%=3600;var g=Math.floor(e/60);var f=e%60;var d=g<10?"0"+g:""+g;var a=f<10?"0"+f:""+f;this.chrono.sec=f;this.chrono.min=g;var b=d+a;var c=b.split("");this.curbmpTime[3].loadTexture("ch"+c[3],0);this.curbmpTime[2].loadTexture("ch"+c[2],0);this.curbmpTime[1].loadTexture("ch"+c[1],0);this.curbmpTime[0].loadTexture("ch"+c[0],0)},tweenAndText:function(b){this.texte.frame=b;this.texte.visible=true;var a=game.add.tween(this.texte.scale).to({x:this.initScale*this.scb,y:this.initScale*this.scb},300,Phaser.Easing.Elastic.Out);a.start();a.onComplete.add(function(){if(b==0){this.cardnomatch.play("",0,0.3,false,true)}if(b==1){this.cardmatch.play("",0,0.3,false,true)}if(b==2){this.music.stop();this.allcards.play("",0,0.3,false,true)}var c=game.add.tween(this.texte.scale).to({x:0.1,y:0.1},200,Phaser.Easing.Elastic.In,true,this.delayFlip/1.8);c.onComplete.add(function(){this.texte.visible=false;if(b==1){this.isFlipping=false;game.input.enabled=true;this.ctimer.resume()}if(b==2){this.levelID;this.isFlipping=false;game.input.enabled=true;game.state.start("finish",true,false,{levelID:this.levelID,btmp:this.curbmpTime,chrono:this.chrono})}},this)},this)}};